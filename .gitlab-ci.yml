stages:
  - lint
  - docs
  - verify
  - build_smoke

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

default:
  interruptible: true

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

.rules_heavy: &rules_heavy
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - src/**/*
        - include/**/*
        - Dockerfile
        - docker-compose.yml
        - prometheus/**/*
        - alertmanager/**/*
        - blackbox/**/*
        - scripts/**/*
        - CMakeLists.txt
        - .github/workflows/**/*
        - .gitlab-ci.yml
    - if: $CI_COMMIT_BRANCH
      changes:
        - src/**/*
        - include/**/*
        - Dockerfile
        - docker-compose.yml
        - prometheus/**/*
        - alertmanager/**/*
        - blackbox/**/*
        - scripts/**/*
        - CMakeLists.txt
        - .github/workflows/**/*
        - .gitlab-ci.yml

lint:
  stage: lint
  image: python:3.12-slim
  cache:
    key: pre-commit-${CI_COMMIT_REF_SLUG}
    paths:
      - .cache/pre-commit/
      - .cache/pip/
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends git clang-format
    - pip install --cache-dir .cache/pip pre-commit
  script:
    - test -d lib/prometheus-client-c/prom
    - test -d lib/prometheus-client-c/promhttp
    - chmod +x scripts/check-no-secrets.sh
    - scripts/check-no-secrets.sh
    - pre-commit run --all-files
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

config_checks:
  stage: verify
  image: docker:27-cli
  needs: ["lint"]
  services:
    - name: docker:27-dind
      command: ["--tls=false"]
  before_script:
    - apk add --no-cache bash curl jq
    - docker info
  script:
    - |
      cat > /tmp/ssh_static_configs.yml <<'EOF'
            - targets: ["100.124.161.192:22"]
              labels:
                instance: "ci_ssh"
      EOF
    - |
      awk '
        /__SSH_STATIC_CONFIGS__/ {
          while ((getline line < cfg) > 0) print line
          close(cfg)
          next
        }
        { print }
      ' cfg="/tmp/ssh_static_configs.yml" prometheus/prometheus.yml.tmpl > /tmp/prometheus.yml
    - sed -i "s|__BLACKBOX_ADDRESS__|blackbox:9115|g" /tmp/prometheus.yml
    - docker run --rm --entrypoint /bin/promtool -v /tmp/prometheus.yml:/tmp/prometheus.yml prom/prometheus:v3.9.1 check config /tmp/prometheus.yml
    - docker run --rm --entrypoint /bin/promtool -v "$PWD/prometheus/alert.rules.yml.tmpl:/tmp/alert.rules.yml" prom/prometheus:v3.9.1 check rules /tmp/alert.rules.yml
    - |
      sed \
        -e 's|__TELEGRAM_BOT_TOKEN__|000000:ci_dummy_token|g' \
        -e 's|__TELEGRAM_CHAT_ID__|1|g' \
        alertmanager/alertmanager.yml.tmpl > /tmp/alertmanager.yml
    - docker run --rm --entrypoint /bin/amtool -v /tmp/alertmanager.yml:/tmp/alertmanager.yml prom/alertmanager:v0.28.0 check-config /tmp/alertmanager.yml
  <<: *rules_heavy

native_build:
  stage: verify
  image: debian:bookworm-slim
  needs: ["lint"]
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends build-essential cmake pkg-config libmicrohttpd-dev
  script:
    - test -d lib/prometheus-client-c/prom
    - test -d lib/prometheus-client-c/promhttp
    - cmake -S lib/prometheus-client-c/prom -B /tmp/build-prom -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local
    - cmake --build /tmp/build-prom --config Release -j"$(nproc)"
    - cmake --install /tmp/build-prom
    - cmake -S lib/prometheus-client-c/promhttp -B /tmp/build-promhttp -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local
    - cmake --build /tmp/build-promhttp --config Release -j"$(nproc)"
    - cmake --install /tmp/build-promhttp
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
    - cmake --build build --config Release -j"$(nproc)"
  <<: *rules_heavy

build_and_smoke:
  stage: build_smoke
  image: docker:27-cli
  needs: ["lint", "docs", "config_checks", "native_build"]
  retry: 1
  services:
    - name: docker:27-dind
      command: ["--tls=false"]
  before_script:
    - apk add --no-cache bash curl jq
    - docker info
    - docker compose version
  script:
    - |
      cat > .env <<EOF
      TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-000000:ci_dummy_token}
      TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-1}
      SSH_TARGETS=${SSH_TARGETS:-100.124.161.192:22}
      NETWORK_INTERFACE=${NETWORK_INTERFACE:-}
      MONITOR_BIND_ADDR=${MONITOR_BIND_ADDR:-127.0.0.1}
      EOF
    - test -d lib/prometheus-client-c/prom
    - test -d lib/prometheus-client-c/promhttp
    - docker compose config
    - docker compose up -d --build --remove-orphans
    - docker compose exec -T app sh -lc "printf 'cpu_usage_percentage,memory_usage_percentage,disk_usage_percentage' > /tmp/monitor_fifo"
    - chmod +x scripts/ci-smoke.sh
    - bash scripts/ci-smoke.sh
    - docker compose ps
  after_script:
    - mkdir -p ci-logs
    - docker compose logs --no-color app > ci-logs/app.log || true
    - docker compose logs --no-color prometheus > ci-logs/prometheus.log || true
    - docker compose logs --no-color blackbox > ci-logs/blackbox.log || true
    - docker compose logs --no-color alertmanager > ci-logs/alertmanager.log || true
    - docker compose logs --no-color grafana > ci-logs/grafana.log || true
    - docker compose down -v || true
  artifacts:
    when: always
    paths:
      - ci-logs/
    expire_in: 7 days
  <<: *rules_heavy

docs:
  stage: docs
  image: debian:bookworm-slim
  needs: ["lint"]
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends doxygen graphviz bash
  script:
    - chmod +x scripts/check-docs.sh
    - bash scripts/check-docs.sh
  artifacts:
    when: on_failure
    paths:
      - dox_errors.txt
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
